# 異常検知テストの仕組みについて

## 質問: 異常なテストデータはないのに、なぜ異常と判定されたものが3件あるのか？

## 答え

### 1. IsolationForestの動作原理

IsolationForestは**教師なし異常検知**アルゴリズムです。学習データには異常ラベルは必要ありません。

- **contamination=0.1** で学習（10%を異常とする設定）
- 学習データから「正常な分布」を学習
- しかし、学習データの中でも「他のデータと比べて外れている」ものは異常スコアが低くなる
- 異常スコア < 閾値 なら異常と判定

### 2. 学習データの扱い

```
学習データ（ecommerce_clustering_data.csv）: 164件
├─ すべて「正常な購買データ」として扱われる
├─ しかし、その中でも「外れ値」は存在する
└─ IsolationForestは contamination=0.1 で学習
   → 学習データの約10%（16件程度）は「異常」として扱われる可能性がある
```

### 3. テストデータの生成過程

```
1. 学習データから10件をサンプリング
2. 実際のモデルに各データを通す
3. モデルが出力した is_anomaly を expected_is_anomaly として記録
4. これがテストデータ（cluster_detection_cases_real.csv）となる
```

### 4. なぜ異常と判定されたのか

テストデータの3件が異常と判定された理由：

1. **学習データ全体の分布から見て、その3件は「外れ値」だった**
   - 同じクラスタ内でも、購買パターン（金額、商品カテゴリなど）が他のデータと大きく異なっていた

2. **IsolationForestのアルゴリズム上**
   - contamination=0.1 で学習しているため、学習データの10%程度は「異常」として扱われる
   - その3件は、学習データ全体から見て「正常な分布から外れている」と判定された

3. **具体的な例**
   - **ケース1**: 22歳、120,000円 → クラスタ2の平均購買額と比較して高額
   - **ケース7**: 65歳、36,000円（数量3） → クラスタ3の購買パターンから外れている
   - **ケース8**: 55歳、120,000円 → クラスタ1の平均購買額と比較して高額

### 5. 重要なポイント

- **異常なテストデータは存在しない**
  - すべて学習データからサンプリングした「正常な購買データ」

- **しかし、モデルは「外れ値」として異常と判定した**
  - IsolationForestは「正常な分布から外れている」ものを異常と判定
  - 学習データの中でも、他のデータと比べて外れているものは異常と判定される

- **テストデータの「異常」は、モデル自身が判定した結果**
  - 人間が「これは異常だ」とラベル付けしたものではない
  - モデルが「正常な分布から外れている」と自動的に判定したもの
  - そのため、モデルが同じ判定を返す限り、検知率は100%になる

### 6. より実用的な評価方法

現在のテストは「モデルの再現性」を確認するものですが、より実用的な評価には：

1. **外部でラベル付けされた独立したテストデータ**
   - 過去の不正取引データ
   - 専門家がラベル付けしたデータ

2. **実際の運用データでの評価**
   - 本番環境で検知された異常の精度
   - False Positive Rate（誤検知率）の測定

## まとめ

- 学習データには異常ラベルは存在しない
- IsolationForestは contamination=0.1 で学習（10%を異常とする設定）
- 学習データの中でも「外れ値」は異常と判定される可能性がある
- テストデータの「異常」は、モデル自身が判定した結果
- そのため、モデルが同じ判定を返す限り、検知率は100%になる

